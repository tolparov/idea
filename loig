package ru.sber.poirot.notifications.kafka

import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty
import org.springframework.stereotype.Component
import ru.sber.kafka.producer.MetricsKafkaProducer
import ru.sber.utils.logger

@Component
@ConditionalOnProperty(value = ["spring.kafka.producer.notification.enable"], havingValue = "true")
class NotificationProducer(
    private val kafkaProducer: MetricsKafkaProducer<String, NotificationEvent>
) {
    private val log = logger()
    
    companion object {
        // ‚úÖ –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –∫–ª—é—á–µ–π —Ç—Ä–∏–≥–≥–µ—Ä–∞ –∫–µ—à–∞
        private const val TRIGGER_CREATED = "notification.created"
        private const val TRIGGER_UPDATED = "notification.updated"
        private const val TRIGGER_ARCHIVED = "notification.archived"
    }
    
    private suspend fun sendEvent(event: NotificationEvent, triggerKey: String) {
        try {
            log.info("üì§ Sending notification event to Kafka: type={}, id={}, key={}",
                event.type, event.notificationId, triggerKey)
            
            kafkaProducer.send(
                event = event,
                key = triggerKey,  // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—Ä–∏–≥–≥–µ—Ä-–∫–ª—é—á –≤–º–µ—Å—Ç–æ ID!
                onCompleteAlways = { e, throwable ->
                    if (throwable != null) {
                        log.error("‚ùå Failed to send notification event to Kafka: {}",
                            throwable.message, throwable)
                    } else {
                        log.debug("‚úÖ Notification event sent to Kafka: type={}, id={}",
                            e.type, e.notificationId)
                    }
                }
            )
        } catch (e: Exception) {
            log.error("‚ùå Error sending notification event to Kafka: {}", e.message, e)
        }
    }
    
    suspend fun sendCreated(notificationId: Long) {
        sendEvent(
            NotificationEvent(NotificationEvent.EventType.CREATED, notificationId),
            TRIGGER_CREATED  // ‚úÖ –ö–ª—é—á –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ –∫–µ—à–∞
        )
    }
    
    suspend fun sendUpdated(notificationId: Long) {
        sendEvent(
            NotificationEvent(NotificationEvent.EventType.UPDATED, notificationId),
            TRIGGER_UPDATED  // ‚úÖ –ö–ª—é—á –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ –∫–µ—à–∞
        )
    }
    
    suspend fun sendArchived(notificationId: Long) {
        sendEvent(
            NotificationEvent(NotificationEvent.EventType.ARCHIVED, notificationId),
            TRIGGER_ARCHIVED  // ‚úÖ –ö–ª—é—á –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ –∫–µ—à–∞
        )
    }
}
