private fun heartbeat(lastSeen: AtomicLong, session: WebSocketSession): Flux<WebSocketMessage> =
        Flux.interval(Duration.ofSeconds(30))
            .flatMap {
                val now = System.currentTimeMillis()
                val timeSinceLastSeen = now - lastSeen.get()

                if (timeSinceLastSeen >= 90_000) {
                    log.warn("Session {} timed out (no activity for {}ms). Closing.",
                        session.id, timeSinceLastSeen)
                    BroadcastRegistry.unregister(session.id)
                    session.close().subscribe()
                    Mono.empty<WebSocketMessage>()
                } else {
                    log.debug("Sending PING to session {}", session.id)
                    val ping = session.textMessage(WsMessage.ping().toJson())
                    session.send(Mono.just(ping))
                        .doOnError { e ->
                            log.warn("Failed to send ping to {}: {}", session.id, e.message)
                            BroadcastRegistry.unregister(session.id)
                            session.close().subscribe()
                        }
                        .subscribe()
                    Mono.just(ping)
                }
            }
