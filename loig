package ru.sber.poirot.engine.ds.refreshable.delayers.kafka

import ru.sber.poirot.engine.ds.refreshable.delayers.channel.BufferTimeoutChannelDelayer
import ru.sber.utils.logger
import java.util.concurrent.ConcurrentHashMap

object KafkaDelayerReceptionist {
    private val log = logger()
    private val delayersByTriggerName =
        ConcurrentHashMap<String, ArrayList<BufferTimeoutChannelDelayer<KafkaUpdateEvent>>>()

    fun register(
        refreshableName: String,
        triggerNames: List<String>,
        delayer: BufferTimeoutChannelDelayer<KafkaUpdateEvent>
    ) {
        triggerNames.distinct().forEach {
            delayersByTriggerName.merge(it, arrayListOf(delayer)) { old, new -> old.apply { addAll(new) } }
        }
        log.info("Registered kafka delayer for triggerNames=$triggerNames, refreshable=$refreshableName")
    }

    operator fun get(triggerName: String): List<BufferTimeoutChannelDelayer<KafkaUpdateEvent>> =
        delayersByTriggerName[triggerName] ?: emptyList()
}
