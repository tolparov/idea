package ru.sber.poirot.notifications.kafka

import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty
import org.springframework.stereotype.Component
import ru.sber.kafka.producer.MetricsKafkaProducer
import ru.sber.utils.logger

@Component
@ConditionalOnProperty(value = ["spring.kafka.producer.notification.enable"], havingValue = "true")
class NotificationProducer(
    private val kafkaProducer: MetricsKafkaProducer<String, NotificationEvent>
) {

    private val log = logger()

    suspend fun sendEvent(event: NotificationEvent) {
        try {
            log.info("üì§ Sending notification event to Kafka: type={}, id={}",
                event.type, event.notificationId)

            kafkaProducer.send(
                event = event,
                key = event.notificationId.toString(),
                onCompleteAlways = { e, throwable ->
                    if (throwable != null) {
                        log.error("‚ùå Failed to send notification event to Kafka: {}",
                            throwable.message, throwable)
                    } else {
                        log.debug("‚úÖ Notification event sent to Kafka: type={}, id={}",
                            e.type, e.notificationId)
                    }
                }
            )

        } catch (e: Exception) {
            log.error("‚ùå Error sending notification event to Kafka: {}", e.message, e)
        }
    }

    suspend fun sendCreated(notificationId: Long) {
        sendEvent(NotificationEvent(NotificationEvent.EventType.CREATED, notificationId))
    }

    suspend fun sendUpdated(notificationId: Long) {
        sendEvent(NotificationEvent(NotificationEvent.EventType.UPDATED, notificationId))
    }

    suspend fun sendArchived(notificationId: Long) {
        sendEvent(NotificationEvent(NotificationEvent.EventType.ARCHIVED, notificationId))
    }
}
